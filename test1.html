<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Test 1</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <style>
    .checkbox-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1;
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .checkbox-column {
      display: flex;
      flex-direction: column;
    }
    .checkbox-column label {
      margin-bottom: 5px;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      margin: 0;
      margin-right: 10px;
    }
    .checkbox-row input[type="checkbox"] {
      margin-right: 5px;
    }
    .checkbox-label span {
      margin-left: 5px;
      min-width: 80px;
    }
  </style>
</head>
<body>
  <a-scene>
    <a-sky color="#5d86a6"></a-sky>
    <a-camera position="0 1.6 3">
      <a-cursor></a-cursor>
    </a-camera>
    <a-entity id="sphere-container"></a-entity>
    <div class="checkbox-container">
      <div class="checkbox-row">
        <div class="checkbox-column">
          <label class="checkbox-label"><input type="checkbox" id="checkbox1"><span>Mix</span></label>
          <label class="checkbox-label"><input type="checkbox" id="checkbox3"><span>KL-1</span></label>
          <label class="checkbox-label"><input type="checkbox" id="checkbox5"><span>Sphere</span></label>
          <label class="checkbox-label"><input type="checkbox" id="checkbox7"><span>Mode-1</span></label>
        </div>
        <div class="checkbox-column">
          <label class="checkbox-label"><input type="checkbox" id="checkbox2"><span>Split</span></label>
          <label class="checkbox-label"><input type="checkbox" id="checkbox4"><span>KL-2</span></label>
          <label class="checkbox-label"><input type="checkbox" id="checkbox6"><span>Cylinder</span></label>
          <label class="checkbox-label"><input type="checkbox" id="checkbox8"><span>Mode-2</span></label>
        </div>
      </div>
    </div>
  </a-scene>

  <script>
    const jsonUrl = "mix064097.json";

    let currentlyPlayingSound = null;
    let startTime = null;

    function logDurationAndStopSound() {
      if (currentlyPlayingSound) {
        currentlyPlayingSound.components.sound.stopSound();
        const endTime = new Date();
        const duration = (endTime - startTime) / 1000; // Duration in seconds
        const soundPath = currentlyPlayingSound.getAttribute('src');
        console.log(`Duration: ${duration}s, Audio Path: ${soundPath}`);
        startTime = null;
        currentlyPlayingSound = null;
      }
    }

    function loadAndCreateSpheres(url) {
      fetch(url)
        .then((response) => response.json())
        .then((data) => {
          const container = document.getElementById("sphere-container");
          const radius = 200; // Radius of the cylinder
          const maxX = Math.max(...data.map(item => item.point[0]));
          const minX = Math.min(...data.map(item => item.point[0]));
          const rangeX = maxX - minX;

          data.forEach((item) => {
            const point = item.point;
            const soundPath = item.path;
            const x2d = point[0];
            const y2d = point[1];

            // Convert 2D coordinates to cylindrical coordinates
            const theta = ((x2d - minX) / rangeX) * 2 * Math.PI;
            const x3d = radius * Math.cos(theta);
            const z3d = radius * Math.sin(theta);
            const y3d = y2d;

            const sphere = document.createElement("a-sphere");
            sphere.setAttribute("position", `${x3d} ${y3d} ${z3d}`);
            sphere.setAttribute("radius", "2");
            sphere.setAttribute("color", "white");

            const sound = document.createElement("a-sound");
            sound.setAttribute("src", soundPath);
            sound.setAttribute("autoplay", "false");
            sound.setAttribute("volume", "50");
            sound.setAttribute("preload", "auto"); // Preload the sound to avoid initial noise

            sphere.appendChild(sound);
            container.appendChild(sphere);

            sphere.addEventListener("mouseenter", () => {
              if (currentlyPlayingSound) {
                logDurationAndStopSound();
              }
              sound.components.sound.playSound();
              currentlyPlayingSound = sound;
              startTime = new Date();
            });

            sphere.addEventListener("mouseleave", () => {
              if (currentlyPlayingSound === sound) {
                sound.components.sound.stopSound();
                logDurationAndStopSound();
              }
            });

            // Handle the end of the sound
            sound.addEventListener('sound-ended', () => {
              logDurationAndStopSound();
            });
          });
        })
        .catch((error) => console.error("Error loading JSON:", error));
    }

    loadAndCreateSpheres(jsonUrl);
  </script>
</body>
</html>
