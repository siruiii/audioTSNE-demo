<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Test 1</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <style>
    .checkbox-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1;
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .checkbox-column {
      display: flex;
      flex-direction: column;
    }
    .checkbox-column label {
      margin-bottom: 5px;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      margin: 0;
      margin-right: 10px;
    }
    .checkbox-row input[type="checkbox"] {
      margin-right: 5px;
    }
    .checkbox-label span {
      margin-left: 5px;
      min-width: 80px;
    }
  </style>
</head>
<body>
  <a-scene>
    <a-sky color="#5d86a6"></a-sky>
    <a-camera position="0 1.6 3">
      <a-cursor></a-cursor>
    </a-camera>
    <a-entity id="sphere-container"></a-entity>
    <div class="checkbox-container">
      <div class="checkbox-row">
        <div class="checkbox-column">
          <label class="checkbox-label"><input type="checkbox" id="checkbox1"><span>Mix</span></label>
          <label class="checkbox-label"><input type="checkbox" id="checkbox3"><span>KL-1</span></label>
          <label class="checkbox-label"><input type="checkbox" id="checkbox5"><span>Far</span></label>
          <label class="checkbox-label"><input type="checkbox" id="checkbox7"><span>Mode-1</span></label>
        </div>
        <div class="checkbox-column">
          <label class="checkbox-label"><input type="checkbox" id="checkbox2"><span>Split</span></label>
          <label class="checkbox-label"><input type="checkbox" id="checkbox4"><span>KL-2</span></label>
          <label class="checkbox-label"><input type="checkbox" id="checkbox6"><span>Close</span></label>
          <label class="checkbox-label"><input type="checkbox" id="checkbox8"><span>Mode-2</span></label>
        </div>
        <button onclick="getCheckboxStatuses()">Configurate</button>
      </div>
    </div>
  </a-scene>

  <script>
    let currentlyPlayingSound = null;
    let startTime = null;

    function logDurationAndStopSound() {
      if (currentlyPlayingSound) {
        currentlyPlayingSound.components.sound.stopSound();
        const endTime = new Date();
        const duration = (endTime - startTime) / 1000; // Duration in seconds
        const soundPath = currentlyPlayingSound.getAttribute('src');
        console.log(`Duration: ${duration}s, Audio Path: ${soundPath}`);
        startTime = null;
        currentlyPlayingSound = null;
      }
    }

    function testPlaySound(sound) {
      const originalVolume = sound.getAttribute('volume');
      sound.setAttribute('volume', '0');
      
      setTimeout(() => {
        if (sound && sound.components && sound.components.sound) {
          sound.components.sound.playSound();
          setTimeout(() => {
            sound.components.sound.stopSound();
            sound.setAttribute('volume', originalVolume);
          }, 500);
        } else {
          console.error('Sound component not found or not initialized.');
        }
      }, 100);
    }

    function loadAndCreateSpheres(url, dist, choice) {
      console.log(url);
      let scale = 1;
      if (url == "split0015443.json") {
        scale = 100;
      } else if (url == "split0612777.json") {
        scale = 0.8;
      } else if (url == "mix064097.json") {
        scale = 2;
      }
      let mode = choice;

      if (dist=="far"){
        r=350;
        vol=80;
      }else if (dist=="close"){
        r=150;
        vol=50;
      }

      // Clear previous spheres
      const container = document.getElementById("sphere-container");
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }

      fetch(url)
        .then((response) => response.json())
        .then((data) => {
          const radius = r;
          const maxX = Math.max(...data.map(item => item.point[0]));
          const minX = Math.min(...data.map(item => item.point[0]));
          const rangeX = maxX - minX;

          data.forEach((item) => {
            const point = item.point;
            const soundPath = item.path;
            const x2d = point[0] * scale;
            const y2d = point[1] * scale;

            const theta = ((x2d - minX) / rangeX) * 2 * Math.PI;
            const x3d = radius * Math.cos(theta);
            const z3d = radius * Math.sin(theta);
            const y3d = y2d;

            const sphere = document.createElement("a-sphere");
            sphere.setAttribute("position", `${x3d} ${y3d} ${z3d}`);
            sphere.setAttribute("radius", "2");
            sphere.setAttribute("color", "white");

            const sound = document.createElement("a-sound");
            sound.setAttribute("src", soundPath);
            sound.setAttribute("autoplay", "false");
            sound.setAttribute("volume", vol);
            sound.setAttribute("preload", "auto");

            sphere.appendChild(sound);
            container.appendChild(sphere);

            testPlaySound(sound);

            if (mode == "nogreen") {
              sphere.addEventListener("mouseenter", () => {
                if (currentlyPlayingSound && currentlyPlayingSound.parentElement !== sphere) {
                  logDurationAndStopSound();
                }

                if (!currentlyPlayingSound || currentlyPlayingSound.parentElement !== sphere) {
                  sound.components.sound.playSound();
                  currentlyPlayingSound = sound;
                  startTime = new Date();
                }
              });

              sound.addEventListener('sound-ended', () => {
                logDurationAndStopSound();
              });
            } else if (mode == "green") {
              sphere.addEventListener("mouseenter", () => {
                if (currentlyPlayingSound && currentlyPlayingSound.parentElement !== sphere) {
                  logDurationAndStopSound();
                }
                if (sphere.getAttribute('color') === 'white') {
                sphere.setAttribute('color', 'green');
              }

                if (!currentlyPlayingSound || currentlyPlayingSound.parentElement !== sphere) {
                  sound.components.sound.playSound();
                  currentlyPlayingSound = sound;
                  startTime = new Date();
                }
              });

              sound.addEventListener('sound-ended', () => {
                logDurationAndStopSound();
              });
            }
          });
        })
        .catch((error) => console.error("Error loading JSON:", error));
    }

    function setupCheckboxes() {
      const groups = [
        ['checkbox1', 'checkbox2'],
        ['checkbox3', 'checkbox4'],
        ['checkbox5', 'checkbox6'],
        ['checkbox7', 'checkbox8']
      ];

      groups.forEach(group => {
        group.forEach(id => {
          const checkbox = document.getElementById(id);
          checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
              group.forEach(cbId => {
                if (cbId !== id) {
                  document.getElementById(cbId).checked = false;
                }
              });
            }
          });
        });
      });

      // Initialize checkboxes 1, 3, 5, 7
      // document.getElementById('checkbox1').checked = true;
      // document.getElementById('checkbox3').checked = true;
      // document.getElementById('checkbox5').checked = true;
      // document.getElementById('checkbox7').checked = true;
    }

    function getCheckboxStatuses() {
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      const checkedIds = [];
      
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          checkedIds.push(checkbox.id);
        }
      });

      if (checkedIds.includes('checkbox1') && checkedIds.includes('checkbox3')) {
        if (checkedIds.includes('checkbox5')) {
          if (checkedIds.includes('checkbox7')) {
            loadAndCreateSpheres("mix0301757.json", "far", "nogreen");
          } else if (checkedIds.includes('checkbox8')) {
            loadAndCreateSpheres("mix0301757.json", "far", "green");
          }
        } else if (checkedIds.includes('checkbox6')) {
          if (checkedIds.includes('checkbox7')) {
            loadAndCreateSpheres("mix0301757.json", "close", "nogreen");
          } else if (checkedIds.includes('checkbox8')) {
            loadAndCreateSpheres("mix0301757.json",  "close", "green");
          }
        }
      } else if (checkedIds.includes('checkbox1') && checkedIds.includes('checkbox4')) {
        if (checkedIds.includes('checkbox5')) {
          if (checkedIds.includes('checkbox7')) {
            loadAndCreateSpheres("mix064097.json", "far", "nogreen");
          } else if (checkedIds.includes('checkbox8')) {
            loadAndCreateSpheres("mix064097.json", "far", "green");
          }
        } else if (checkedIds.includes('checkbox6')) {
          if (checkedIds.includes('checkbox7')) {
            loadAndCreateSpheres("mix064097.json",  "close", "nogreen");
          } else if (checkedIds.includes('checkbox8')) {
            loadAndCreateSpheres("mix064097.json",  "close", "green");
          }
        }
      } else if (checkedIds.includes('checkbox2') && checkedIds.includes('checkbox3')) {
        if (checkedIds.includes('checkbox5')) {
          if (checkedIds.includes('checkbox7')) {
            loadAndCreateSpheres("split0015443.json", "far", "nogreen");
          } else if (checkedIds.includes('checkbox8')) {
            loadAndCreateSpheres("split0015443.json", "far", "green");
          }
        } else if (checkedIds.includes('checkbox6')) {
          if (checkedIds.includes('checkbox7')) {
            loadAndCreateSpheres("split0015443.json", "close", "nogreen");
          } else if (checkedIds.includes('checkbox8')) {
            loadAndCreateSpheres("split0015443.json", "close", "green");
          }
        }
      } else if (checkedIds.includes('checkbox2') && checkedIds.includes('checkbox4')) {
        if (checkedIds.includes('checkbox5')) {
          if (checkedIds.includes('checkbox7')) {
            loadAndCreateSpheres("split0612777.json", "far", "nogreen");
          } else if (checkedIds.includes('checkbox8')) {
            loadAndCreateSpheres("split0612777.json", "far", "green");
          }
        } else if (checkedIds.includes('checkbox6')) {
          if (checkedIds.includes('checkbox7')) {
            loadAndCreateSpheres("split0612777.json", "close", "nogreen");
          } else if (checkedIds.includes('checkbox8')) {
            loadAndCreateSpheres("split0612777.json", "close", "green");
          }
        }
      }
    }

    setupCheckboxes();
  </script>
</body>
</html>
